---
route: /extensions/smart-context/
---

# 智能上下文

## **此扩展不再维护,不建议使用。请考虑[聊天向量化](/extensions/Chat-vectorization.md)作为可能的替代方案。**

!!!warning 免责声明
使用此扩展不能保证更好的聊天体验或改善任何形式的记忆。仅在您了解使用向量数据库的所有含义时使用。
!!!

### 它是什么?

智能上下文是一个 SillyTavern 扩展,它使用 [ChromaDB 库](https://www.trychroma.com) 让您的 AI 角色访问存在于正常聊天历史上下文限制之外的信息。

### 这有什么用?

如果您有一个非常长的聊天,大部分内容都在通常的上下文窗口之外,因此在 AI 编写响应时不可用。

智能上下文会自动将聊天文件的完整历史记录放入向量数据库。然后,每次您在聊天中输入新内容时,都会搜索此数据库,如果找到具有匹配关键字的消息,则这些聊天消息会被放入上下文中,以便 AI 在编写下一个回复时可以看到它们。

***

### 设置说明

1. 将 SillyTavern 更新到至少 1.10.6 版本。
2. 从扩展面板(堆叠方块图标)的"下载扩展和资源"菜单中安装"智能上下文"扩展。
3. 将 [Extras](https://github.com/SillyTavern/SillyTavern-extras) 安装或更新到最新版本。或者,使用 [Colab 笔记本](https://colab.research.google.com/github/SillyTavern/SillyTavern/blob/release/colab/GPU.ipynb)。
4. *仅限本地安装:* 为 Extras 安装 requirements-complete.txt(即使您之前在之前的安装中这样做过)。
5. 启用 chromadb 模块运行 Extras:`python server.py --enable-modules=chromadb`

#### 安装 ChromaDB 时遇到错误?

```
ERROR: Could not build wheels for hnswlib, which is required to install pyproject.toml-based projects
```

安装 chromadb 包需要以下之一:

- 安装了 Visual C++ 构建工具: <https://visualstudio.microsoft.com/visual-cpp-build-tools/>
- 从 conda 安装 hnswlib: `conda install -c conda-forge hnswlib`

***

### 配置

启用智能上下文后,您应该在 SillyTavern UI 中配置它。
可以从扩展菜单 ![ST扩展菜单图标](/static/extensions/menu-icon.png) 中完成智能上下文配置

![智能上下文配置面板](/static/extensions/smart-context.png)

需要注意 4 个主要概念:

- 聊天历史保留
- 记忆注入数量
- 单个记忆长度
- 注入策略

***

#### 智能上下文仅在聊天历史中有 10 条消息后才开始

- 在新聊天开始时,ChromaDB 处于非活动状态。
- 一旦聊天累积了 10 条消息,它将开始将所有消息记录到数据库中,并根据需要调用消息。

#### 聊天历史保留("保留的消息")

默认情况下,ChromaDB 将保留滑块中指定的最近自然聊天历史消息数量。
超过此数量的任何消息都将从您发送的提示中删除,如果数据库中存在"记忆",它们将被添加以替代较旧的聊天历史消息(请参阅下面的策略)。

***

#### 记忆注入数量

智能上下文将插入上下文的最大"记忆"数量。
并非每次注入尝试都会获得此完整数量。
如果您发送与"狗"相关的输入,而数据库中只有另一条与狗相关的消息,则只会插入 1 个项目。

***

#### 单个记忆长度

这是每个注入的"记忆"允许的最大长度。
这是以**字符**(不是标记)为单位。
如果设置得太小,记忆可能会被中途切断。

示例:

`Ross: I like dogs with long fur and fluffy tails. I dislike dogs with short fur and short tails.`

此数据库"记忆"有 103 个字符长,因此您需要将滑块设置为至少 `103` 才能将其完全拉入上下文。

如果滑块小于 103,消息将被切断并像那样注入。

***

### 注入策略

#### 替换最旧的历史

此策略保留 X 条最近的消息,删除此之前的所有消息,并用"记忆"替换它们。

优点

- 不太可能溢出您的上下文限制
- 存在于上下文顶部附近的记忆对响应的直接影响较小,同时仍然提供"背景信息"。

缺点

- 旧消息直接插入聊天历史中,没有特殊标记,并且通常与保留的自然聊天历史消息没有直接的自然相关性。这可能会混淆不太智能的 AI 模型。

#### 添加到底部

此策略保持聊天历史的自然状态,并在其**之后**在格式化的[括号标题]内添加"记忆"。
这意味着"保留的消息"滑块实际上被禁用。

优点

- 不缩短或更改当前的自然聊天历史
- "记忆"存在于聊天之后,对下一个 AI 响应有更强的影响

缺点

- 因为没有聊天项目被删除/替换,所以溢出上下文限制的可能性更高。
- 因为记忆存在于提示末尾非常接近的位置,它们可能对 AI 的响应产生过多影响。

#### 自定义深度

此策略保持聊天历史的自然状态,并在您在指定的模板中确定的深度添加"记忆"。
这意味着"保留的消息"滑块实际上被禁用。
自定义注入消息应包括 `{{memories}}` 模板词,这是放置所有查询记忆的位置。

优点

- 灵活地实验记忆放置
- 可自定义的上下文中记忆的介绍

缺点

- 因为没有聊天项目被删除/替换,所以溢出上下文限制的可能性更高。


#### 使用 % 策略

注意:这与"添加到底部"策略不兼容,后者根本不删除任何消息。

在使用"替换最旧历史"策略时,选中此框将启用滑块以选择上下文中聊天历史的百分比以用智能上下文记忆替换。它还将禁用用于手动选择消息数量的两个滑块。

此策略自动计算要用智能上下文记忆替换的聊天历史的百分比,而不是固定数量的消息。

优点

- 比手动计算消息数量更容易
- 随可用上下文大小调整,对小型和大型提示空间应用相同的百分比

缺点

- 要删除多少历史记录的计算可能略有不准确,因为它们基于每条消息的估计标记
- 它将要删除的消息数量四舍五入到可被 5 整除的最接近数字(0、5、10、15、20 等),因此不如手动数字选择精细。

***

### 记忆调用策略

#### 仅从此聊天中调用

这是智能上下文的默认行为,仅从此特定聊天的 ChromaDB 集合中提取"记忆"。

#### 从所有角色聊天中调用

这是智能上下文的实验性行为,它从所选角色的所有 ChromaDB 集合中提取"记忆"。
从假设上讲,这应该允许开发跨越多次交互的更强大的记忆集。
建议与"添加到底部"或"自定义深度"策略一起使用,并将"保留的消息"设置为较低的数字,以便 ChromaDB 更快地从记忆中提取。

### 使用智能上下文

启用并配置后,智能上下文会自动发生。

ChromaDB 为 SillyTavern 内打开的每个聊天创建一个新数据库。
此数据库自动填充完整的聊天历史记录。

您还可以手动将文本文件插入数据库。

这些文本文件不必是聊天。它们可以是任何内容(维基百科条目、同人小说等)。

#### 清除数据库

您可以使用"清除数据库"按钮清除当前聊天的数据库。

如果您发现存储了不准确的记忆(例如您已删除或编辑的聊天消息),这可能会有所帮助。

***

### 常见问题

#### 聊天完成后数据库会怎样?我可以保存它们吗?

对于本地安装的 Extras 服务器,智能上下文会保存数据库。在通常的使用情况下无需手动保存它们。

对于 colab 用户,当 extras 服务器关闭时数据库会被清除。使用导出按钮将数据库保存为 JSON 文件,并在下次要使用它时导入它。

**通常无需保存智能上下文数据库。**

目前我们有一个导入/导出功能,允许您保存聊天的数据库并在以后再次使用它。

#### 我可以为所有聊天制作一个大数据库来引用吗?

这不是智能上下文功能的良好使用。
我们建议为此目的使用世界信息。
