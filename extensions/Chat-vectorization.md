---
route: /extensions/chat-vectorization/
tags:
    [
        vector storage,
        RAG,
        retrieval-augmented generation,
        vectors,
        summarization,
        chats,
        messages
    ]
---

# 聊天向量化

!!!warning 免责声明
使用此扩展不能保证更好的聊天体验或改进任何类型的记忆。仅在您了解向量数据库利用的所有含义时使用。
!!!

聊天向量化在您当前的聊天历史中搜索与您最近的消息相关的消息。
它会暂时将最相关的消息移动到聊天历史的开头或结尾。
这发生在生成模型对您最后一条消息的回复时。

聊天历史开头和结尾的消息往往对模型的回复影响最大。
因此,将相关消息移到这些位置可以帮助模型在其回复中关注相关信息。

特别是,聊天向量化可以找到在消息历史中太靠后而无法适应请求上下文的相关消息。将这些消息移入上下文为模型提供了它本来没有的信息。

聊天向量化是一种检索增强生成(RAG)。检索增强生成通过在提示中提供额外的相关信息来提高模型生成响应的质量。

* 检索:使用最近的消息检索相关的过去消息
* 增强:通过以有用的方式插入过去的消息来增强模型的上下文
* 生成:指示模型在生成响应时使用过去的消息

!!!info 一些术语:
*向量*是一组数字,可以表示一段文本的主题、内容、风格或其他特征。

*向量化*是计算表示一段文本的向量。这由向量化模型完成。
就像文本生成模型从文本生成文本一样,向量化模型从文本生成向量。

*向量搜索*通过比较向量而不是关键字来查找相关结果。如果我们计算搜索查询的向量,我们可以将其与文本集合的存储向量进行比较。这将在我们的集合中找到与搜索查询中的文本最相似的文本。在聊天向量化的情况下,"搜索查询"是最近的 2 条消息,"我们集合中的文本"是聊天中的所有其他消息。
!!!

## 设置

!!!warning 提示缓存兼容性
像任何动态提示源(世界信息、摘要等)一样,聊天向量化在 LLM 调用之间重组提示前缀,这可能导致频繁的缓存未命中。与缓存一起使用时,向量化通常会适得其反,因为修改后的提示很少命中缓存 - 有效地使缓存无用。您必须选择其中之一,但不能两者兼得。
!!!

要启用聊天向量化,请选择"扩展" > "向量存储" > "为聊天消息启用"。

配置向量化源和向量化模型。聊天向量化使用与数据库相同的向量源,因此您可能已经设置过了。向量化源和向量化模型的设置记录在[数据库](/Usage/Characters/data-bank.md)中。

聊天向量化使用与数据库相同的向量存储,但这不需要设置或配置。
[数据库](/Usage/Characters/data-bank.md)中也有关于向量存储的信息。

聊天向量化不使用数据库来存储聊天消息。消息存储在聊天中。

## 准备聊天消息以进行搜索(向量存储)

为了可以搜索聊天消息,为每条消息计算并存储一个向量。

向量化在后台进行,每当您发送或接收消息时。

每条消息单独存储,以便在生成期间可以单独找到和移动它。

大消息被分成"块",以便模型可以获得长消息中最相关的部分。块大小为 400 个字符。
您可以使用"块大小(字符)"更改此设置。

消息通过查找块边界(如段落分隔符、换行符或单词之间的空格)来划分为块。这是为了使所有块尽可能有意义。如果您的聊天消息有其他方式标记自然分割点,例如 `----`,您可以将其添加到"块边界"。"块边界"的设置与数据库共享。

### 向量存储控制

要为当前聊天中的所有消息计算向量,而无需等待它们在后台处理,请从设置中选择"全部向量化"。

要查看当前聊天中有多少消息已向量化,请选择"查看统计"。这将显示存储的向量总数。
它还通过用绿色球标记指示已向量化的特定聊天消息。

要删除当前聊天中消息的所有向量,请选择"清除向量"。

!!!
**聊天向量化内**的"全部向量化"和"清除向量"控件仅影响当前聊天的存储向量。
但是,文件向量化中有相同的按钮,会影响数据库中文件的向量。确保您清除的是您打算清除的向量。
!!!

## 查找要移动的相关消息(向量检索)

要在聊天历史中找到最相关的消息,最近的消息被转换(向量化)为查询向量。默认情况下,使用最近的 2 条消息。要更改此设置,请更改"查询消息"的值。此值在从数据库查找相关内容时也使用。

过去的消息必须具有至少 25% 的相关性分数才能被包括在内。您可以使用"分数阈值"更改此设置。分数阈值的设置与数据库共享。

聊天历史中最相关的 3 条消息被移动。您可以使用"插入#"更改此设置。

为避免干扰聊天中最近的事件,不会移动最近的 5 条消息。要更改此设置,请更改"保留#"的值。

## 移动消息(增强生成)

消息被移到 3 个位置之一:

* 聊天顶部,在主提示/故事字符串之后(默认)
* 聊天顶部,在主提示/故事字符串*之前*
* 聊天结尾,在最后 2 条消息之前("聊天中 @ 深度 2")。由于您刚刚发送了一条消息,此位置通常在模型之前的回复之前。

您可以使用"注入位置"和"深度"更改此设置。

消息按相关性顺序包含在内,相关性更高的消息显示在相关性较低的消息之后。

包含发送每条消息的人或角色的名称。

消息作为"过去事件"显示给模型。这有助于模型理解消息包含来自聊天历史中与插入点不同的信息。您可以使用"注入模板"更改此设置。

您可以使用提示项目化弹出窗口、终端日志或浏览器控制台日志查看模型的最终提示。浏览器控制台日志对于了解聊天向量化中的所有步骤在做什么很有用。

## 向量摘要

!!!warning 警告
向量摘要功能是实验性的。

**向量摘要不会创建聊天摘要。它不会将检索到的消息转换为摘要。它不会使您的聊天历史更短。它不是"像[摘要](/extensions/Summarize.md)但更好"。**
!!!

向量摘要旨在使聊天消息的向量搜索更有效。它通过在向量化之前引入摘要步骤来实现这一点。摘要步骤提取消息中最重要的部分,以便生成的向量更好地指示消息的相关内容。

向量摘要可能会降低向量搜索的有效性。

要摘要聊天历史中的消息,并为每条摘要的消息生成一个向量,请选择"为向量生成摘要聊天消息"。

摘要的消息不会替换聊天中的原始消息。如果向量搜索匹配摘要消息的向量,则从聊天历史中检索原始消息并移入上下文。摘要版本的消息保留在向量存储中,这可能对调试有用。

要摘要用于搜索聊天历史的消息内容(默认为最后 2 条消息),请选择"发送时摘要聊天消息"。

每次为向量化摘要消息时,都会向摘要模型发出单独的请求。您可以使用"摘要方式"选择使用哪个摘要源。选择"主 API"将使用与生成聊天或文本完成相同的模型和连接设置生成摘要。

请求包含原始消息内容和有关模型应如何生成摘要的指令。您可以使用"摘要提示"更改指令。