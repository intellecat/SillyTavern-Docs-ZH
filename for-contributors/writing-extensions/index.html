<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q5KW2CN7R1"></script>
    <script data-cfasync="false">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-Q5KW2CN7R1');</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.817210997328">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>UI 扩展 | SillyTavern傻酒馆中文文档</title>
    <meta name="title" content="UI 扩展 | SillyTavern傻酒馆中文文档">
    <meta name="description" content="UI 扩展通过挂钩到 SillyTavern 的事件和 API 来扩展其功能。它们在浏览器环境中运行，几乎可以无限制地访问 DOM、JavaScript API 和 SillyTavern 上下文。扩展可以修改 UI、调用内部 API 并与聊天数据交互。本指南介绍如何创建您自己的扩展(需要...">

    <!-- Canonical -->
    <link rel="canonical" href="https://docs.sillytavern.app/for-contributors/writing-extensions/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://docs.sillytavern.app/for-contributors/writing-extensions/">
    <meta property="og:title" content="UI 扩展 | SillyTavern傻酒馆中文文档">
    <meta property="og:description" content="UI 扩展通过挂钩到 SillyTavern 的事件和 API 来扩展其功能。它们在浏览器环境中运行，几乎可以无限制地访问 DOM、JavaScript API 和 SillyTavern 上下文。扩展可以修改 UI、调用内部 API 并与聊天数据交互。本指南介绍如何创建您自己的扩展(需要...">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://docs.sillytavern.app/for-contributors/writing-extensions/">
    <meta property="twitter:title" content="UI 扩展 | SillyTavern傻酒馆中文文档">
    <meta property="twitter:description" content="UI 扩展通过挂钩到 SillyTavern 的事件和 API 来扩展其功能。它们在浏览器环境中运行，几乎可以无限制地访问 DOM、JavaScript API 和 SillyTavern 上下文。扩展可以修改 UI、调用内部 API 并与聊天数据交互。本指南介绍如何创建您自己的扩展(需要...">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../resources/css/retype.css?v=3.11.0.817210997328" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.11.0.817210997328" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.11.0.817210997328" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../resources/js/prism.js?v=3.11.0.817210997328" defer></script>

    <style>
        a {
            color: brown !important;
        }

        .dark a {
            color: rgb(223, 151, 18) !important;
        }

        body {
            font-family: Noto Sans, sans-serif;
        }

        .callout {
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #d2d6dc;
            border-radius: 0.375rem;
        }

        .callout p {
            margin-bottom: 0.5rem !important;
            overflow: hidden;
        }

        .callout p:last-child {
            margin-bottom: 0 !important;
        }

        .callout .fa-fw {
            margin: 1rem 0.5rem 1rem 0;
            color: slategrey;
        }

        .docs-markdown .codeblock code,
        .docs-markdown .codeblock pre {
            white-space: pre-wrap;
        }
    </style>
    <link href="/static/webfonts/NotoSans/stylesheet.css" rel="stylesheet" />
    <link href="/static/css/fontawesome.min.css" rel="stylesheet" />
    <link href="/static/css/solid.min.css" rel="stylesheet" />
    <link href="/static/css/brands.min.css" rel="stylesheet" />

</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../" class="flex items-center leading-snug text-xl">
                            <span class="w-10 mr-2 grow-0 shrink-0 overflow-hidden">
                                <img class="max-h-10 dark:hidden md:inline-block" src="../../static/logo.png">
                                <img class="max-h-10 hidden dark:inline-block" src="../../static/logo.png">
                            </span>
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">SillyTavern中文文档</span>
                        </a>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/SillyTavern/SillyTavern">GitHub</a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://discord.gg/sillytavern">Discord</a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://www.reddit.com/r/SillyTavernAI/">Reddit</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/SillyTavern/SillyTavern">GitHub</a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://discord.gg/sillytavern">Discord</a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://www.reddit.com/r/SillyTavernAI/">Reddit</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="ui-扩展" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#ui-扩展">#</doc-anchor-trigger>
        <span>UI 扩展</span>
    </h1>
</doc-anchor-target>
<p>UI 扩展通过挂钩到 SillyTavern 的事件和 API 来扩展其功能。它们在浏览器环境中运行，几乎可以无限制地访问 DOM、JavaScript API 和 SillyTavern 上下文。扩展可以修改 UI、调用内部 API 并与聊天数据交互。本指南介绍如何创建您自己的扩展(需要 JavaScript 知识)。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-tip"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-tip" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M7.90625 2.15625C4.50944 2.15625 2.15625 4.58563 2.15625 7.54688C2.15625 8.96138 2.76575 9.88281 3.57075 10.8589L3.87837 11.2226C4.19894 11.6021 4.554 12.0218 4.84581 12.4416C5.25406 13.0324 5.61775 13.7296 5.7385 14.5834C5.76728 14.8608 5.68746 15.1386 5.51579 15.3583C5.34413 15.5781 5.09399 15.7228 4.8179 15.7621C4.5418 15.8013 4.26124 15.7321 4.03512 15.5689C3.809 15.4056 3.65493 15.1612 3.60525 14.8867C3.54775 14.4814 3.37094 14.1004 3.07338 13.6692C2.8306 13.3302 2.57055 13.0039 2.29425 12.6917C2.1735 12.5479 2.04556 12.397 1.909 12.2317C1.00769 11.1406 0 9.72613 0 7.54688C0 3.32062 3.39681 0 7.90625 0C12.4157 0 15.8125 3.32062 15.8125 7.54688C15.8125 9.72613 14.8048 11.1406 13.9035 12.2317C13.7669 12.397 13.639 12.5479 13.5183 12.6903C13.2207 13.0424 12.9677 13.3414 12.7406 13.6692C12.4416 14.1004 12.2662 14.4814 12.2087 14.8867C12.1557 15.1584 12.0003 15.3994 11.7747 15.5598C11.5492 15.7202 11.2706 15.7879 10.9965 15.7488C10.7225 15.7096 10.474 15.5667 10.3023 15.3496C10.1306 15.1325 10.0489 14.8577 10.074 14.582C10.1948 13.7296 10.5584 13.0324 10.9667 12.4416C11.2585 12.0218 11.6136 11.6021 11.9341 11.2226C12.0419 11.0961 12.1454 10.9739 12.2403 10.8589C13.0468 9.88281 13.6562 8.96138 13.6562 7.54688C13.6562 4.58563 11.3031 2.15625 7.90625 2.15625ZM4.67188 17.25H11.1406C11.4266 17.25 11.7008 17.3636 11.903 17.5658C12.1052 17.768 12.2188 18.0422 12.2188 18.3281C12.2188 18.6141 12.1052 18.8883 11.903 19.0905C11.7008 19.2927 11.4266 19.4062 11.1406 19.4062H4.67188C4.38594 19.4062 4.11171 19.2927 3.90953 19.0905C3.70734 18.8883 3.59375 18.6141 3.59375 18.3281C3.59375 18.0422 3.70734 17.768 3.90953 17.5658C4.11171 17.3636 4.38594 17.25 4.67188 17.25ZM5.03125 21.9219C5.03125 21.6359 5.14484 21.3617 5.34703 21.1595C5.54921 20.9573 5.82344 20.8438 6.10938 20.8438H9.70312C9.98906 20.8438 10.2633 20.9573 10.4655 21.1595C10.6677 21.3617 10.7812 21.6359 10.7812 21.9219C10.7812 22.2078 10.6677 22.482 10.4655 22.6842C10.2633 22.8864 9.98906 23 9.70312 23H6.10938C5.82344 23 5.54921 22.8864 5.34703 22.6842C5.14484 22.482 5.03125 22.2078 5.03125 21.9219Z" />
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>只想安装扩展?</h5>
<p>前往这里:<a href="../../extensions/">Extensions</a>。</p>
        </div>
    </div>
</div>
<p>要扩展 Node.js 服务器的功能，请参阅 <a href="../server-plugins/">Server Plugins</a> 页面。</p>
<p><strong>不会写 JavaScript?</strong></p>
<ul>
<li>考虑使用 <a href="../../usage/st-script/">STscript</a> 作为编写完整扩展的简单替代方案。</li>
<li>学习 <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript">MDN 课程</a>，完成后再回来。</li>
</ul>
<doc-anchor-target id="扩展提交">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#扩展提交">#</doc-anchor-trigger>
        <span>扩展提交</span>
    </h2>
</doc-anchor-target>
<p>想要将您的扩展贡献到 <a href="https://github.com/SillyTavern/SillyTavern-Content">官方内容仓库</a>? 联系我们!</p>
<p>为确保所有扩展安全且易于使用，我们有一些要求:</p>
<ol>
<li>您的扩展必须是开源的，并具有自由许可证(参见 <a href="https://choosealicense.com/licenses/">选择许可证</a>)。如果不确定，AGPLv3 是个不错的选择。</li>
<li>扩展必须与最新发布版本的 SillyTavern 兼容。如果核心发生变化，请准备好更新您的扩展。</li>
<li>扩展必须有完善的文档。这包括一个包含安装说明、使用示例和功能列表的 README 文件。</li>
<li>需要 server plugin 才能运行的扩展将不被接受。</li>
</ol>
<doc-anchor-target id="示例">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#示例">#</doc-anchor-trigger>
        <span>示例</span>
    </h2>
</doc-anchor-target>
<p>查看简单 SillyTavern 扩展的实时示例:</p>
<ul>
<li><a href="https://github.com/city-unit/st-extension-example">https://github.com/city-unit/st-extension-example</a> - 基础扩展模板。展示 manifest 创建、本地脚本导入、添加设置 UI 面板和持久化扩展设置的使用。</li>
<li><a href="https://github.com/search?q=topic%3Aextension+org%3ASillyTavern&amp;type=Repositories">https://github.com/search?q=topic%3Aextension+org%3ASillyTavern&amp;type=Repositories</a> - GitHub 上所有官方 SillyTavern 扩展的列表。</li>
</ul>
<doc-anchor-target id="打包">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#打包">#</doc-anchor-trigger>
        <span>打包</span>
    </h2>
</doc-anchor-target>
<p>扩展还可以使用打包工具将自己与其他模块隔离，并使用 NPM 中的任何依赖项，包括 Vue、React 等 UI 框架。</p>
<ul>
<li><a href="https://github.com/SillyTavern/Extension-WebpackTemplate">https://github.com/SillyTavern/Extension-WebpackTemplate</a> - 使用 TypeScript 和 Webpack 的扩展模板仓库(无 React)。</li>
<li><a href="https://github.com/SillyTavern/Extension-ReactTemplate">https://github.com/SillyTavern/Extension-ReactTemplate</a> - 使用 React 和 Webpack 的基础扩展模板仓库。</li>
</ul>
<p>要从打包的文件中使用相对导入，您可能需要创建一个导入包装器。以下是 Webpack 的示例:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">/**
 * Import a member from a module by URL， bypassing webpack.
 * @param {string} url URL to import from
 * @param {string} what Name of the member to import
 * @param {any} defaultValue Fallback value
 * @returns {Promise&lt;any&gt;} Imported member
 */
export async function importFromUrl(url， what， defaultValue = null) {
    try {
        const module = await import(/* webpackIgnore: true */ url);
        if (!Object.hasOwn(module， what)) {
            throw new Error(`No ${what} in module`);
        }
        return module[what];
    } catch (error) {
        console.error(`Failed to import ${what} from ${url}: ${error}`);
        return defaultValue;
     }
}

// Import a function from 'script.js' module
const generateRaw = await importFromUrl('/script.js'， 'generateRaw');</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="manifestjson">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#manifestjson">#</doc-anchor-trigger>
        <span>manifest.json</span>
    </h2>
</doc-anchor-target>
<p>每个扩展都必须在 <code v-pre>data/&lt;user-handle&gt;/extensions</code> 中有一个文件夹和一个 <code v-pre>manifest.json</code> 文件，该文件包含有关扩展的元数据以及作为扩展入口点的 JS 脚本文件的路径。</p>
<p>可下载的扩展在通过 HTTP 提供服务时会被挂载到 <code v-pre>/scripts/extensions/third-party</code> 文件夹中，因此应该基于此使用相对导入。为方便本地开发，建议将扩展仓库放在 <code v-pre>/scripts/extensions/third-party</code> 文件夹中(&quot;为所有用户安装&quot;选项)。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
    &quot;display_name&quot;: &quot;The name of the extension&quot;，
    &quot;loading_order&quot;: 1，
    &quot;requires&quot;: []，
    &quot;optional&quot;: []，
    &quot;dependencies&quot;: []，
    &quot;js&quot;: &quot;index.js&quot;，
    &quot;css&quot;: &quot;style.css&quot;，
    &quot;author&quot;: &quot;Your name&quot;，
    &quot;version&quot;: &quot;1.0.0&quot;，
    &quot;homePage&quot;: &quot;https://github.com/your/extension&quot;，
    &quot;auto_update&quot;: true，
    &quot;minimum_client_version&quot;: &quot;1.0.0&quot;，
    &quot;i18n&quot;: {
        &quot;de-de&quot;: &quot;i18n/de-de.json&quot;
    }
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="manifest-字段">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#manifest-字段">#</doc-anchor-trigger>
        <span>Manifest 字段</span>
    </h3>
</doc-anchor-target>
<ul>
<li><code v-pre>display_name</code> 是必需的。它显示在&quot;管理扩展&quot;菜单中。</li>
<li><code v-pre>loading_order</code> 是可选的。数字越大，加载越晚。</li>
<li><code v-pre>js</code> 是主 JS 文件引用，是必需的。</li>
<li><code v-pre>css</code> 是可选的样式文件引用。</li>
<li><code v-pre>author</code> 是必需的。应包含作者的姓名或联系信息。</li>
<li><code v-pre>auto_update</code> 设置为 <code v-pre>true</code> 时，当 ST 包的版本更改时，扩展将自动更新。</li>
<li><code v-pre>i18n</code> 是一个可选对象，指定支持的语言环境及其对应的 JSON 文件(见下文)。</li>
<li><code v-pre>dependencies</code> 是一个可选的字符串数组，指定此扩展依赖的其他<strong>扩展</strong>。</li>
<li><code v-pre>generate_interceptor</code> 是一个可选字符串，指定在文本生成请求时调用的全局函数名称。</li>
<li><code v-pre>minimum_client_version</code> 是一个可选字符串，指定此扩展正常工作所需的最低 SillyTavern 版本。</li>
</ul>
<doc-anchor-target id="依赖项">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#依赖项">#</doc-anchor-trigger>
        <span>依赖项</span>
    </h3>
</doc-anchor-target>
<p>扩展也可以依赖其他 SillyTavern 扩展。如果缺少或禁用了这些依赖项中的任何一个，扩展将不会加载。</p>
<p>依赖项由其在 <code v-pre>public/extensions</code> 目录中显示的<strong>文件夹名称</strong>指定。</p>
<p>示例:</p>
<ul>
<li>内置扩展: <code v-pre>&quot;vectors&quot;</code>， <code v-pre>&quot;caption&quot;</code></li>
<li>第三方扩展: <code v-pre>&quot;third-party/Extension-WebLLM&quot;</code>， <code v-pre>&quot;third-party/Extension-Mermaid&quot;</code></li>
</ul>
<doc-anchor-target id="已弃用的字段">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#已弃用的字段">#</doc-anchor-trigger>
        <span>已弃用的字段</span>
    </h3>
</doc-anchor-target>
<ul>
<li><code v-pre>requires</code> 是一个可选的字符串数组，指定所需的 <strong>Extras 模块</strong>。如果连接的 Extras API 不提供所有列出的模块，扩展将不会加载。</li>
<li><code v-pre>optional</code> 是一个可选的字符串数组，指定可选的 <strong>Extras 模块</strong>。如果缺少这些模块，扩展仍将加载，扩展应优雅地处理它们的缺失。</li>
</ul>
<p>要检查当前连接的 Extras API 提供哪些模块，请从 <code v-pre>scripts/extensions.js</code> 导入 <code v-pre>modules</code> 数组。</p>
<doc-anchor-target id="脚本编写">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#脚本编写">#</doc-anchor-trigger>
        <span>脚本编写</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="使用-getcontext">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#使用-getcontext">#</doc-anchor-trigger>
        <span>使用 getContext</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>SillyTavern</code> 全局对象中的 <code v-pre>getContext()</code> 函数可以让您访问 SillyTavern 上下文，这是所有主要应用状态对象、有用函数和实用程序的集合。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const context = SillyTavern.getContext();
context.chat; // Chat log - MUTABLE
context.characters; // Character list
context.characterId; // Index of the current character
context.groups; // Group list
context.groupId; // ID of the current group
// And many more...</code></pre>
</doc-codeblock></div>
<p>您可以在 <a href="https://github.com/SillyTavern/SillyTavern/blob/staging/public/scripts/st-context.js">SillyTavern 源代码</a>中找到可用属性和函数的完整列表。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-primary"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-primary" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>如果 <code v-pre>getContext</code> 中缺少任何您需要的函数/属性，请联系开发人员或向我们发送 pull request!</p>
        </div>
    </div>
</div>
<doc-anchor-target id="共享库">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#共享库">#</doc-anchor-trigger>
        <span>共享库</span>
    </h3>
</doc-anchor-target>
<p>SillyTavern 前端内部使用的大多数 npm 库都在 <code v-pre>SillyTavern</code> 全局对象的 <code v-pre>libs</code> 属性中共享。</p>
<ul>
<li><code v-pre>lodash</code> - 实用程序库。<a href="https://lodash.com/">文档</a>。</li>
<li><code v-pre>localforage</code> - 浏览器存储库。<a href="https://localforage.github.io/localForage/">文档</a>。</li>
<li><code v-pre>Fuse</code> - 模糊搜索库。<a href="https://www.fusejs.io/">文档</a>。</li>
<li><code v-pre>DOMPurify</code> - HTML 清理库。<a href="https://github.com/cure53/DOMPurify">文档</a>。</li>
<li><code v-pre>Handlebars</code> - 模板库。<a href="https://handlebarsjs.com/">文档</a>。</li>
<li><code v-pre>moment</code> - 日期/时间操作库。<a href="http://momentjs.com/">文档</a>。</li>
<li><code v-pre>showdown</code> - Markdown 转换库。<a href="https://showdownjs.com/">文档</a>。</li>
</ul>
<p>您可以在 <a href="https://github.com/SillyTavern/SillyTavern/blob/staging/public/lib.js">SillyTavern 源代码</a>中找到导出库的完整列表。</p>
<p><strong>示例:</strong> 使用 DOMPurify 库。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { DOMPurify } = SillyTavern.libs;

const sanitizedHtml = DOMPurify.sanitize('&lt;script&gt;&quot;dirty HTML&quot;&lt;/script&gt;');</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="typescript-注意事项">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#typescript-注意事项">#</doc-anchor-trigger>
        <span>TypeScript 注意事项</span>
    </h3>
</doc-anchor-target>
<p>如果您想要 <code v-pre>SillyTavern</code> 全局对象中所有方法的自动完成功能(您可能想要)，包括 <code v-pre>getContext()</code> 和 <code v-pre>libs</code>，您应该添加一个 TypeScript <code v-pre>.d.ts</code> 模块声明。此声明应从 SillyTavern 的源代码导入全局类型，具体取决于您的扩展位置。以下示例适用于两种安装类型:&quot;所有用户&quot;和&quot;当前用户&quot;。</p>
<p><strong>global.d.ts</strong> - 将此文件放在扩展目录的根目录中(<code v-pre>manifest.json</code> 旁边):</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-typescript"><code v-pre class="language-typescript">export {};

// 1. Import for user-scoped extensions
import '../../../../public/global';
// 2. Import for server-scoped extensions
import '../../../../global';

// Define additional types if needed...
declare global {
    // Add global type declarations here
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="从其他文件导入">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#从其他文件导入">#</doc-anchor-trigger>
        <span>从其他文件导入</span>
    </h3>
</doc-anchor-target>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-warning"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-warning" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>从 SillyTavern 代码导入是不可靠的，如果 ST 模块的内部结构发生变化，可能会随时中断。<code v-pre>getContext</code> 提供了更稳定的 API。</p>
        </div>
    </div>
</div>
<p>除非您正在构建打包的扩展，否则您可以从其他 JS 文件导入变量和函数。</p>
<p>例如，此代码片段将在后台从当前选择的 API 生成回复:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">import { generateQuietPrompt } from &quot;../../../../script.js&quot;;

async function handleMessage(data) {
    const text = data.message;
    const translated = await generateQuietPrompt({ quietPrompt: text });
    // ...
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="状态管理">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#状态管理">#</doc-anchor-trigger>
        <span>状态管理</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="持久化设置">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#持久化设置">#</doc-anchor-trigger>
        <span>持久化设置</span>
    </h3>
</doc-anchor-target>
<p>当扩展需要持久化其状态时，它可以使用 <code v-pre>getContext()</code> 函数中的 <code v-pre>extensionSettings</code> 对象来存储和检索数据。扩展可以在设置对象中存储任何 JSON 可序列化的数据，并且必须使用唯一的键来避免与其他扩展冲突。</p>
<p>要持久化设置，请使用 <code v-pre>saveSettingsDebounced()</code> 函数，该函数将设置保存到服务器。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { extensionSettings， saveSettingsDebounced } = SillyTavern.getContext();

// Define a unique identifier for your extension
const MODULE_NAME = 'my_extension';

// Define default settings
const defaultSettings = Object.freeze({
    enabled: false，
    option1: 'default'，
    option2: 5
});

// Define a function to get or initialize settings
function getSettings() {
    // Initialize settings if they don't exist
    if (!extensionSettings[MODULE_NAME]) {
        extensionSettings[MODULE_NAME] = structuredClone(defaultSettings);
    }

    // Ensure all default keys exist (helpful after updates)
    for (const key of Object.keys(defaultSettings)) {
        if (!Object.hasOwn(extensionSettings[MODULE_NAME]， key)) {
            extensionSettings[MODULE_NAME][key] = defaultSettings[key];
        }
    }

    return extensionSettings[MODULE_NAME];
}

// Use the settings
const settings = getSettings();
settings.option1 = 'new value';

// Save the settings
saveSettingsDebounced();</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="聊天元数据">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#聊天元数据">#</doc-anchor-trigger>
        <span>聊天元数据</span>
    </h3>
</doc-anchor-target>
<p>要将某些数据绑定到特定聊天，您可以使用 <code v-pre>getContext()</code> 函数中的 <code v-pre>chatMetadata</code> 对象。此对象允许您存储与聊天关联的任意数据，这对于存储特定于扩展的状态很有用。</p>
<p>要持久化元数据，请使用 <code v-pre>saveMetadata()</code> 函数，该函数将元数据保存到服务器。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-warning"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-warning" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>不要在长期变量中保存对 <code v-pre>chatMetadata</code> 的引用，因为切换聊天时引用会改变。始终使用 <code v-pre>SillyTavern.getContext().chatMetadata</code> 来访问当前聊天元数据。</p>
        </div>
    </div>
</div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { chatMetadata， saveMetadata } = SillyTavern.getContext();

// Set some metadata for the current chat
chatMetadata['my_key'] = 'my_value';

// Get the metadata for the current chat
const value = chatMetadata['my_key'];

// Save the metadata to the server
await saveMetadata();</code></pre>
</doc-codeblock></div>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-tip"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-tip" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M7.90625 2.15625C4.50944 2.15625 2.15625 4.58563 2.15625 7.54688C2.15625 8.96138 2.76575 9.88281 3.57075 10.8589L3.87837 11.2226C4.19894 11.6021 4.554 12.0218 4.84581 12.4416C5.25406 13.0324 5.61775 13.7296 5.7385 14.5834C5.76728 14.8608 5.68746 15.1386 5.51579 15.3583C5.34413 15.5781 5.09399 15.7228 4.8179 15.7621C4.5418 15.8013 4.26124 15.7321 4.03512 15.5689C3.809 15.4056 3.65493 15.1612 3.60525 14.8867C3.54775 14.4814 3.37094 14.1004 3.07338 13.6692C2.8306 13.3302 2.57055 13.0039 2.29425 12.6917C2.1735 12.5479 2.04556 12.397 1.909 12.2317C1.00769 11.1406 0 9.72613 0 7.54688C0 3.32062 3.39681 0 7.90625 0C12.4157 0 15.8125 3.32062 15.8125 7.54688C15.8125 9.72613 14.8048 11.1406 13.9035 12.2317C13.7669 12.397 13.639 12.5479 13.5183 12.6903C13.2207 13.0424 12.9677 13.3414 12.7406 13.6692C12.4416 14.1004 12.2662 14.4814 12.2087 14.8867C12.1557 15.1584 12.0003 15.3994 11.7747 15.5598C11.5492 15.7202 11.2706 15.7879 10.9965 15.7488C10.7225 15.7096 10.474 15.5667 10.3023 15.3496C10.1306 15.1325 10.0489 14.8577 10.074 14.582C10.1948 13.7296 10.5584 13.0324 10.9667 12.4416C11.2585 12.0218 11.6136 11.6021 11.9341 11.2226C12.0419 11.0961 12.1454 10.9739 12.2403 10.8589C13.0468 9.88281 13.6562 8.96138 13.6562 7.54688C13.6562 4.58563 11.3031 2.15625 7.90625 2.15625ZM4.67188 17.25H11.1406C11.4266 17.25 11.7008 17.3636 11.903 17.5658C12.1052 17.768 12.2188 18.0422 12.2188 18.3281C12.2188 18.6141 12.1052 18.8883 11.903 19.0905C11.7008 19.2927 11.4266 19.4062 11.1406 19.4062H4.67188C4.38594 19.4062 4.11171 19.2927 3.90953 19.0905C3.70734 18.8883 3.59375 18.6141 3.59375 18.3281C3.59375 18.0422 3.70734 17.768 3.90953 17.5658C4.11171 17.3636 4.38594 17.25 4.67188 17.25ZM5.03125 21.9219C5.03125 21.6359 5.14484 21.3617 5.34703 21.1595C5.54921 20.9573 5.82344 20.8438 6.10938 20.8438H9.70312C9.98906 20.8438 10.2633 20.9573 10.4655 21.1595C10.6677 21.3617 10.7812 21.6359 10.7812 21.9219C10.7812 22.2078 10.6677 22.482 10.4655 22.6842C10.2633 22.8864 9.98906 23 9.70312 23H6.10938C5.82344 23 5.54921 22.8864 5.34703 22.6842C5.14484 22.482 5.03125 22.2078 5.03125 21.9219Z" />
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>切换聊天时会发出 <code v-pre>CHAT_CHANGED</code> 事件，因此您可以监听此事件以相应地更新扩展的状态。请参阅<doc-anchor-trigger to="#listening-to-events">监听事件</doc-anchor-trigger>部分了解更多信息。</p>
        </div>
    </div>
</div>
<doc-anchor-target id="角色卡片">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#角色卡片">#</doc-anchor-trigger>
        <span>角色卡片</span>
    </h3>
</doc-anchor-target>
<p>SillyTavern 完全支持 <a href="https://github.com/malfoyslastname/character-card-spec-v2/blob/main/spec_v2.md">Character Cards V2 规范</a>，允许在角色卡片 JSON 数据中存储任意数据。</p>
<p>这对于需要存储与角色关联的附加数据并在导出角色卡片时使其可共享的扩展很有用。</p>
<p>要将数据写入角色卡片 <a href="https://github.com/malfoyslastname/character-card-spec-v2/blob/main/spec_v2.md#extensions">extensions</a> 数据字段，请使用 <code v-pre>getContext()</code> 函数中的 <code v-pre>writeExtensionField</code> 函数。此函数接受角色 ID、字符串键和要写入的值。该值必须是 JSON 可序列化的。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-warning"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-warning" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>注意奇怪的地方</h5>
<p>尽管被称为 <code v-pre>characterId</code>，但它不是&quot;真正的&quot;唯一标识符，而是 <code v-pre>characters</code> 数组中角色的索引。</p>
<p>当前角色的索引由上下文中的 <code v-pre>characterId</code> 属性提供。如果要将数据写入当前选择的角色，请使用 <code v-pre>SillyTavern.getContext().characterId</code>。如果需要为另一个角色存储数据，请通过在 <code v-pre>characters</code> 数组中搜索角色来找到索引。</p>
<p><strong>注意:<code v-pre>characterId</code> 在群聊或未选择角色时为 <code v-pre>undefined</code>!</strong></p>
        </div>
    </div>
</div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { writeExtensionField， characterId } = SillyTavern.getContext();

// Write some data to the character card
await writeExtensionField(characterId， 'my_extension_key'， {
    someData: 'value'，
    anotherData: 42
});

// Read the data back from the character card
const character = SillyTavern.getContext().characters[characterId];
// The data is stored in the `extensions` object of the character's data
const myData = character.data?.extensions?.my_extension_key;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="设置预设">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#设置预设">#</doc-anchor-trigger>
        <span>设置预设</span>
    </h3>
</doc-anchor-target>
<p>任意 JSON 数据可以存储在主要 API 类型的设置预设中。它将与预设 JSON 一起导出和导入，因此您可以使用它来存储预设的扩展特定设置。以下 API 类型支持设置预设中的数据扩展:</p>
<ul>
<li>Chat Completion</li>
<li>Text Completion</li>
<li>NovelAI</li>
<li>KoboldAI / AI Horde</li>
</ul>
<p>要读取或写入数据，您首先需要从上下文获取 PresetManager 实例:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { getPresetManager } = SillyTavern.getContext();

// Get the preset manager for the current API type
const pm = getPresetManager();

// Write data to the preset extension field:
// - path: the path to the field in the preset data
// - value: the value to write
// - name (optional): the name of the preset to write to， defaults to the currently selected preset
await pm.writePresetExtensionField({ path: 'hello'， value: 'world' });

// Read data from the preset extension field:
// - path: the path to the field in the preset data
// - name (optional): the name of the preset to read from， defaults to the currently selected preset
const value = pm.readPresetExtensionField({ path: 'hello' });</code></pre>
</doc-codeblock></div>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-tip"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-tip" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M7.90625 2.15625C4.50944 2.15625 2.15625 4.58563 2.15625 7.54688C2.15625 8.96138 2.76575 9.88281 3.57075 10.8589L3.87837 11.2226C4.19894 11.6021 4.554 12.0218 4.84581 12.4416C5.25406 13.0324 5.61775 13.7296 5.7385 14.5834C5.76728 14.8608 5.68746 15.1386 5.51579 15.3583C5.34413 15.5781 5.09399 15.7228 4.8179 15.7621C4.5418 15.8013 4.26124 15.7321 4.03512 15.5689C3.809 15.4056 3.65493 15.1612 3.60525 14.8867C3.54775 14.4814 3.37094 14.1004 3.07338 13.6692C2.8306 13.3302 2.57055 13.0039 2.29425 12.6917C2.1735 12.5479 2.04556 12.397 1.909 12.2317C1.00769 11.1406 0 9.72613 0 7.54688C0 3.32062 3.39681 0 7.90625 0C12.4157 0 15.8125 3.32062 15.8125 7.54688C15.8125 9.72613 14.8048 11.1406 13.9035 12.2317C13.7669 12.397 13.639 12.5479 13.5183 12.6903C13.2207 13.0424 12.9677 13.3414 12.7406 13.6692C12.4416 14.1004 12.2662 14.4814 12.2087 14.8867C12.1557 15.1584 12.0003 15.3994 11.7747 15.5598C11.5492 15.7202 11.2706 15.7879 10.9965 15.7488C10.7225 15.7096 10.474 15.5667 10.3023 15.3496C10.1306 15.1325 10.0489 14.8577 10.074 14.582C10.1948 13.7296 10.5584 13.0324 10.9667 12.4416C11.2585 12.0218 11.6136 11.6021 11.9341 11.2226C12.0419 11.0961 12.1454 10.9739 12.2403 10.8589C13.0468 9.88281 13.6562 8.96138 13.6562 7.54688C13.6562 4.58563 11.3031 2.15625 7.90625 2.15625ZM4.67188 17.25H11.1406C11.4266 17.25 11.7008 17.3636 11.903 17.5658C12.1052 17.768 12.2188 18.0422 12.2188 18.3281C12.2188 18.6141 12.1052 18.8883 11.903 19.0905C11.7008 19.2927 11.4266 19.4062 11.1406 19.4062H4.67188C4.38594 19.4062 4.11171 19.2927 3.90953 19.0905C3.70734 18.8883 3.59375 18.6141 3.59375 18.3281C3.59375 18.0422 3.70734 17.768 3.90953 17.5658C4.11171 17.3636 4.38594 17.25 4.67188 17.25ZM5.03125 21.9219C5.03125 21.6359 5.14484 21.3617 5.34703 21.1595C5.54921 20.9573 5.82344 20.8438 6.10938 20.8438H9.70312C9.98906 20.8438 10.2633 20.9573 10.4655 21.1595C10.6677 21.3617 10.7812 21.6359 10.7812 21.9219C10.7812 22.2078 10.6677 22.482 10.4655 22.6842C10.2633 22.8864 9.98906 23 9.70312 23H6.10938C5.82344 23 5.54921 22.8864 5.34703 22.6842C5.14484 22.482 5.03125 22.2078 5.03125 21.9219Z" />
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>切换预设或主 API 时会发出 <code v-pre>PRESET_CHANGED</code> 和 <code v-pre>MAIN_API_CHANGED</code> 事件，因此您可以监听这些事件以相应地更新扩展的状态。请参阅<doc-anchor-trigger to="#listening-to-events">监听事件</doc-anchor-trigger>部分了解更多信息。</p>
        </div>
    </div>
</div>
<doc-anchor-target id="国际化">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#国际化">#</doc-anchor-trigger>
        <span>国际化</span>
    </h2>
</doc-anchor-target>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-primary"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-primary" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>有关提供翻译的一般信息，请参阅<a href="../i18n/">国际化</a>页面。</p>
        </div>
    </div>
</div>
<p>扩展可以提供额外的本地化字符串，以便与 <code v-pre>t</code>、<code v-pre>translate</code> 函数和 HTML 模板中的 <code v-pre>data-i18n</code> 属性一起使用。</p>
<p>在此处查看支持的语言环境列表(<code v-pre>lang</code> 键): <a href="https://github.com/SillyTavern/SillyTavern/blob/release/public/locales/lang.json">https://github.com/SillyTavern/SillyTavern/blob/release/public/locales/lang.json</a></p>
<doc-anchor-target id="直接调用-addlocaledata">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#直接调用-addlocaledata">#</doc-anchor-trigger>
        <span>直接调用 <code v-pre>addLocaleData</code></span>
    </h3>
</doc-anchor-target>
<p>将语言环境代码和包含翻译的对象传递给 <code v-pre>addLocaleData</code> 函数。<em>不</em>允许覆盖现有键。如果传递的语言环境代码不是当前选择的语言环境，数据将被静默忽略。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">SillyTavern.getContext().addLocaleData('fr-fr'， { 'Hello': 'Bonjour' });
SillyTavern.getContext().addLocaleData('de-de'， { 'Hello': 'Hallo' });</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="通过扩展-manifest">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#通过扩展-manifest">#</doc-anchor-trigger>
        <span>通过扩展 manifest</span>
    </h3>
</doc-anchor-target>
<p>将包含支持的语言环境列表及其对应 JSON 文件路径(相对于扩展目录)的 i18n 对象添加到 manifest 中。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
  &quot;display_name&quot;: &quot;Foobar&quot;，
  &quot;js&quot;: &quot;index.js&quot;，
  // rest of the fields
  &quot;i18n&quot;: {
    &quot;fr-fr&quot;: &quot;i18n/french.json&quot;，
    &quot;de-de&quot;: &quot;i18n/german.json&quot;
  }
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="注册-slash-命令新方法">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#注册-slash-命令新方法">#</doc-anchor-trigger>
        <span>注册 slash 命令(新方法)</span>
    </h2>
</doc-anchor-target>
<p>虽然 <code v-pre>registerSlashCommand</code> 仍然存在以实现向后兼容，但现在应该通过 <code v-pre>SlashCommandParser.addCommandObject()</code> 注册新的 slash 命令，以向解析器(进而向自动完成和命令帮助)提供有关命令及其参数的扩展详细信息。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">SlashCommandParser.addCommandObject(SlashCommand.fromProps({ name: 'repeat'，
    callback: (namedArgs， unnamedArgs) =&gt; {
        return Array(namedArgs.times ?? 5)
            .fill(unnamedArgs.toString())
            .join(isTrueBoolean(namedArgs.space.toString()) ? ' ' : '')
        ;
    }，
    aliases: ['example-command']，
    returns: 'the repeated text'，
    namedArgumentList: [
        SlashCommandNamedArgument.fromProps({ name: 'times'，
            description: 'number of times to repeat the text'，
            typeList: ARGUMENT_TYPE.NUMBER，
            defaultValue: '5'，
        })，
        SlashCommandNamedArgument.fromProps({ name: 'space'，
            description: 'whether to separate the texts with a space'，
            typeList: ARGUMENT_TYPE.BOOLEAN，
            defaultValue: 'off'，
            enumList: ['on'， 'off']，
        })，
    ]，
    unnamedArgumentList: [
        SlashCommandArgument.fromProps({ description: 'the text to repeat'，
            typeList: ARGUMENT_TYPE.STRING，
            isRequired: true，
        })，
    ]，
    helpString: `
        &lt;div&gt;
            Repeats the provided text a number of times.
        &lt;/div&gt;
        &lt;div&gt;
            &lt;strong&gt;Example:&lt;/strong&gt;
            &lt;ul&gt;
                &lt;li&gt;
                    &lt;pre&gt;&lt;code class=&quot;language-stscript&quot;&gt;/repeat foo&lt;/code&gt;&lt;/pre&gt;
                    returns &quot;foofoofoofoofoo&quot;
                &lt;/li&gt;
                &lt;li&gt;
                    &lt;pre&gt;&lt;code class=&quot;language-stscript&quot;&gt;/repeat times=3 space=on bar&lt;/code&gt;&lt;/pre&gt;
                    returns &quot;bar bar bar&quot;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    `，
}));</code></pre>
</doc-codeblock></div>
<p>所有注册的命令都可以在 <a href="../../usage/st-script/">STscript</a> 中以任何可能的方式使用。</p>
<doc-anchor-target id="事件">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#事件">#</doc-anchor-trigger>
        <span>事件</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="监听事件">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#监听事件">#</doc-anchor-trigger>
        <span>监听事件</span>
    </h3>
</doc-anchor-target>
<p>使用 <code v-pre>eventSource.on(eventType， eventHandler)</code> 来监听事件:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { eventSource， event_types } = SillyTavern.getContext();

eventSource.on(event_types.MESSAGE_RECEIVED， handleIncomingMessage);

function handleIncomingMessage(data) {
    // Handle message
}</code></pre>
</doc-codeblock></div>
<p>主要事件类型:</p>
<ul>
<li><code v-pre>APP_READY</code>: 应用完全加载并准备使用。应用准备就绪后，每次附加新监听器时都会自动触发。</li>
<li><code v-pre>MESSAGE_RECEIVED</code>: LLM 消息已生成并记录到 <code v-pre>chat</code> 对象中，但尚未在 UI 中渲染。</li>
<li><code v-pre>MESSAGE_SENT</code>: 消息由用户发送并记录到 <code v-pre>chat</code> 对象中，但尚未在 UI 中渲染。</li>
<li><code v-pre>USER_MESSAGE_RENDERED</code>: 用户发送的消息在 UI 中渲染。</li>
<li><code v-pre>CHARACTER_MESSAGE_RENDERED</code>: 生成的 LLM 消息在 UI 中渲染。</li>
<li><code v-pre>CHAT_CHANGED</code>: 聊天已切换(例如，切换到另一个角色，或加载了另一个聊天)。</li>
<li><code v-pre>GENERATION_AFTER_COMMANDS</code>: 在处理 slash 命令后即将开始生成。</li>
<li><code v-pre>GENERATION_STOPPED</code>: 生成被用户停止。</li>
<li><code v-pre>GENERATION_ENDED</code>: 生成已完成或出错。</li>
<li><code v-pre>SETTINGS_UPDATED</code>: 应用程序设置已更新。</li>
</ul>
<p>其余可以在<a href="https://github.com/SillyTavern/SillyTavern/blob/staging/public/scripts/events.js">源代码</a>中找到。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-info"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-info" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
            <h5>事件数据</h5>
<p>每个事件将数据传递给监听器的方式不统一。有些事件不发出任何数据;有些传递对象或原始值。请参阅发出事件的源代码以查看它传递的数据，或使用调试器检查。</p>
        </div>
    </div>
</div>
<doc-anchor-target id="发出事件">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#发出事件">#</doc-anchor-trigger>
        <span>发出事件</span>
    </h3>
</doc-anchor-target>
<p>您可以通过调用 <code v-pre>eventSource.emit(eventType， ...eventData)</code> 从扩展产生任何应用程序事件，包括自定义事件:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { eventSource } = SillyTavern.getContext();

// Can be a built-in event_types field or any string.
const eventType = 'myCustomEvent';

// Use `await` to ensure all event handlers complete before continuing execution.
await eventSource.emit(eventType， { data: 'custom event data' });</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="prompt-interceptors">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#prompt-interceptors">#</doc-anchor-trigger>
        <span>Prompt Interceptors</span>
    </h2>
</doc-anchor-target>
<p>Prompt Interceptors 提供了一种方式，允许扩展在发出文本生成请求之前执行任何活动，例如修改聊天数据、添加注入或中止生成。</p>
<p>来自不同扩展的 interceptors 按顺序运行。顺序由其各自 <code v-pre>manifest.json</code> 文件中的 <code v-pre>loading_order</code> 字段确定。<code v-pre>loading_order</code> 值较低的扩展较早运行。如果未指定 <code v-pre>loading_order</code>，则使用 <code v-pre>display_name</code> 作为后备。如果两者都未指定，则顺序未定义。</p>
<doc-anchor-target id="注册-interceptor">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#注册-interceptor">#</doc-anchor-trigger>
        <span>注册 Interceptor</span>
    </h3>
</doc-anchor-target>
<p>要定义 prompt interceptor，请在扩展的 <code v-pre>manifest.json</code> 文件中添加 <code v-pre>generate_interceptor</code> 字段。该值应该是 SillyTavern 将调用的全局函数的名称。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-json"><code v-pre class="language-json">{
    &quot;display_name&quot;: &quot;My Interceptor Extension&quot;，
    &quot;loading_order&quot;: 10， // Affects execution order
    &quot;generate_interceptor&quot;: &quot;myCustomInterceptorFunction&quot;，
    // ... other manifest properties
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="interceptor-函数">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#interceptor-函数">#</doc-anchor-trigger>
        <span>Interceptor 函数</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>generate_interceptor</code> 函数是一个全局函数，将在非试运行的生成请求时调用。它必须在全局作用域中定义(例如，<code v-pre>globalThis.myCustomInterceptorFunction = async function(...) { ... }</code>)，并且如果需要执行任何异步操作，可以返回 <code v-pre>Promise</code>。</p>
<p>interceptor 函数接收以下参数:</p>
<ul>
<li><code v-pre>chat</code>: 表示将用于构建 prompt 的聊天历史的消息对象数组。您可以直接修改此数组(例如，添加、删除或更改消息)。请注意，消息是可变的，因此您对数组所做的任何更改都将反映在实际聊天历史中。如果您希望更改是临时的，请使用 <code v-pre>structuredClone</code> 创建消息对象的深层副本。</li>
<li><code v-pre>contextSize</code>: 表示为即将进行的生成计算的当前上下文大小(以 tokens 为单位)的数字。</li>
<li><code v-pre>abort</code>: 调用时将发出信号以阻止文本生成继续进行的函数。它接受一个布尔参数，如果为 <code v-pre>true</code>，则阻止任何后续 interceptors 运行。</li>
<li><code v-pre>type</code>: 表示生成的类型或触发器的字符串(例如，<code v-pre>'quiet'</code>、<code v-pre>'regenerate'</code>、<code v-pre>'impersonate'</code>、<code v-pre>'swipe'</code> 等)。这有助于 interceptor 根据生成的启动方式有条件地应用逻辑。</li>
</ul>
<p><strong>示例实现:</strong></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">globalThis.myCustomInterceptorFunction = async function(chat， contextSize， abort， type) {
    // Example: Add a system note before the last user message
    const systemNote = {
        is_user: false，
        name: &quot;System Note&quot;，
        send_date: Date.now()，
        mes: &quot;This was added by my extension!&quot;
    };
    // Insert before the last message
    chat.splice(chat.length - 1， 0， systemNote);
}</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="生成文本">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#生成文本">#</doc-anchor-trigger>
        <span>生成文本</span>
    </h2>
</doc-anchor-target>
<p>SillyTavern 提供了几个函数，可以使用当前选择的 LLM API 在不同上下文中生成文本。这些函数允许您在聊天上下文中生成文本、无需任何上下文的原始生成，或使用结构化输出。</p>
<doc-anchor-target id="在聊天上下文中">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#在聊天上下文中">#</doc-anchor-trigger>
        <span>在聊天上下文中</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>generateQuietPrompt()</code> 函数用于在后台(输出不在 UI 中渲染)在聊天上下文中使用添加的&quot;quiet&quot; prompt(历史后指令)生成文本。这对于在不中断用户体验的同时生成文本很有用，同时还保持相关的聊天和角色数据完整，例如生成摘要或图像 prompt。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { generateQuietPrompt } = SillyTavern.getContext();

const quietPrompt = 'Generate a summary of the chat history.';

const result = await generateQuietPrompt({
    quietPrompt，
});</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="原始生成">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#原始生成">#</doc-anchor-trigger>
        <span>原始生成</span>
    </h3>
</doc-anchor-target>
<p><code v-pre>generateRaw()</code> 函数用于在没有任何聊天上下文的情况下生成文本。当您想要完全控制 prompt 构建过程时，它很有用。</p>
<p>它接受 <code v-pre>prompt</code> 作为 Text Completion 字符串或 Chat Completion 对象数组，根据所选 API 类型以适当的格式构造请求，例如，在 chat/text 模式之间转换、应用 instruct 格式等。您还可以将额外的 <code v-pre>systemPrompt</code> 和 <code v-pre>prefill</code> 传递给函数，以更好地控制生成过程。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { generateRaw } = SillyTavern.getContext();

const systemPrompt = 'You are a helpful assistant.';
const prompt = 'Generate a story about a brave knight.';
const prefill = 'Once upon a time，';

/*
In Chat Completion mode， will produce a prompt like this:
[
  {role: 'system'， content: 'You are a helpful assistant.'}，
  {role: 'user'， content: 'Generate a story about a brave knight.'}，
  {role: 'assistant'， content: 'Once upon a time，'}
]
*/

/*
In Text Completion mode (no instruct)， will produce a prompt like this:
&quot;You are a helpful assistant.\nGenerate a story about a brave knight.\nOnce upon a time，&quot;
*/

const result = await generateRaw({
    systemPrompt，
    prompt，
    prefill，
});</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="结构化输出">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#结构化输出">#</doc-anchor-trigger>
        <span>结构化输出</span>
    </h3>
</doc-anchor-target>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-info"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-info" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9z"></path>
                    <path d="M12 11c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1s1-.45 1-1v-4c0-.55-.45-1-1-1zM12.01 7c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                    <path fill="none" d="M0 0h24v24H0z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>目前仅 Chat Completion API 支持。可用性因所选源和模型而异。如果所选模型不支持结构化输出，生成将失败或返回空对象(<code v-pre>'{}'</code>)。请查看您使用的特定 API 的文档以查看是否支持结构化输出。</p>
        </div>
    </div>
</div>
<p>您可以使用结构化输出功能来确保模型生成符合提供的 <a href="https://json-schema.org/learn">JSON Schema</a> 的有效 JSON 对象。这对于需要结构化数据的扩展很有用，例如状态跟踪、数据分类等。</p>
<p>要使用结构化输出，您必须将 JSON schema 对象传递给 <code v-pre>generateRaw()</code> 或 <code v-pre>generateQuietPrompt()</code>。然后，模型将生成与 schema 匹配的响应，并将其作为字符串化的 JSON 对象返回。</p>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-warning"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-warning" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>输出不会根据 schema 进行验证，您必须自己处理生成输出的解析和验证。如果模型无法生成有效的 JSON 对象，函数将返回空对象(<code v-pre>'{}'</code>)。</p>
<p><a href="https://zod.dev/json-schema">Zod</a> 是一个流行的库，用于生成和验证 JSON schemas。这里不会涉及其使用。</p>
        </div>
    </div>
</div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { generateRaw， generateQuietPrompt } = SillyTavern.getContext();

// Define a JSON schema for the expected output
const jsonSchema = {
    // Required: a name for the schema
    name: 'StoryStateModel'，
    // Optional: a description of the schema
    description: 'A schema for a story state with location， plans， and memories.'，
    // Optional:  the schema will be used in strict mode， meaning that only the fields defined in the schema will be allowed
    strict: true，
    // Required: a definition of the schema
    value: {
        '$schema': 'http://json-schema.org/draft-04/schema#'，
        'type': 'object'，
        'properties': {
            'location': {
                'type': 'string'
            }，
            'plans': {
                'type': 'string'
            }，
            'memories': {
                'type': 'string'
            }
        }，
        'required': [
            'location'，
            'plans'，
            'memories'
        ]，
    }，
};

const prompt = 'Generate a story state with location， plans， and memories. Output as a JSON object.';

const rawResult = await generateRaw({
    prompt，
    jsonSchema，
});

const quietResult = await generateQuietPrompt({
    quietPrompt: prompt，
    jsonSchema，
});</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="注册自定义宏">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#注册自定义宏">#</doc-anchor-trigger>
        <span>注册自定义宏</span>
    </h2>
</doc-anchor-target>
<p>您可以注册自定义宏，这些宏可以在支持宏替换的任何地方使用，例如在角色卡片字段、STscript 命令、prompt 模板等中。</p>
<p>要注册宏，请使用 <code v-pre>SillyTavern.getContext()</code> 对象中的 <code v-pre>registerMacro()</code> 函数。该函数接受一个宏名称(应该是唯一的字符串)和一个字符串或返回字符串的函数。该函数将使用唯一的 <code v-pre>nonce</code> 字符串调用，该字符串在每次 <code v-pre>substituteParams</code> 调用之间都会不同。</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { registerMacro } = SillyTavern.getContext();

// Simple string macro
registerMacro('fizz'， 'buzz');
// Function macro
registerMacro('tomorrow'， () =&gt; {
    return new Date(Date.now() + 24 * 60 * 60 * 1000).toLocaleDateString();
});</code></pre>
</doc-codeblock></div>
<p>当不再需要自定义宏时，使用 <code v-pre>unregisterMacro()</code> 函数删除它:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">const { unregisterMacro } = SillyTavern.getContext();

// Unregister the 'fizz' macro
unregisterMacro('fizz');</code></pre>
</doc-codeblock></div>
<p><strong>有关自定义宏的重要详细信息和已知限制:</strong></p>
<ol>
<li>目前仅支持简单的字符串替换宏。我们正在努力在未来添加对更复杂宏的支持。</li>
<li>使用函数提供值的宏<em>必须</em>是同步的。返回 <code v-pre>Promise</code> 将不起作用。</li>
<li>注册时不需要用双花括号(<code v-pre>{{ }}</code>)包装宏名称。SillyTavern 会为您执行此操作。</li>
<li>由于宏是纯正则表达式替换，注册大量宏会导致性能问题，因此请谨慎使用。</li>
</ol>
<doc-anchor-target id="执行-extras-请求">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#执行-extras-请求">#</doc-anchor-trigger>
        <span>执行 Extras 请求</span>
    </h2>
</doc-anchor-target>
<div class="flex mb-6">
    <div class="shrink-0 w-1.5 rounded-tl-lg rounded-bl-lg bg-callout-warning"></div>
    <div class="flex w-full py-4 border border-l-0 rounded-tr-lg rounded-br-lg doc-callout bg-callout-base-bg border-callout-base-border" role="alert">
        <div class="flex items-center ml-4 h-7">
            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px text-callout-warning" width="22" height="22" viewBox="0 0 24 24" role="presentation">
                <g fill="currentColor"><g>
                    <path d="M22.48 15.59L14.01 1.45A2.968 2.968 0 0012.16.09c-.78-.19-1.58-.07-2.27.35-.41.25-.76.6-1.01 1.01v.01L.4 15.6c-.83 1.43-.33 3.27 1.1 4.1.45.26.95.4 1.48.4h16.95c.8-.01 1.55-.33 2.11-.9.56-.57.87-1.33.86-2.13a3.04 3.04 0 00-.42-1.48zm-1.87 2.21c-.19.19-.44.3-.69.3H2.99c-.17 0-.34-.05-.49-.13a.992.992 0 01-.37-1.35L10.6 2.48c.08-.14.2-.25.34-.33a.992.992 0 011.37.33l8.46 14.13c.09.15.13.32.13.49 0 .26-.1.51-.29.7z"></path>
                    <path d="M11.45 12.1c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1s-1 .45-1 1v4c0 .56.45 1 1 1zM11.46 14.1c-.56 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"></path>
                </g></g>
            </svg>
        </div>
        <div class="pr-5 ml-3 w-full">
<p>Extras API 已弃用。不建议在新扩展中使用它。</p>
        </div>
    </div>
</div>
<p><code v-pre>doExtrasFetch()</code> 函数允许您向 SillyTavern Extras API 服务器发出请求。</p>
<p>例如，要调用 <code v-pre>/api/summarize</code> 端点:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-javascript"><code v-pre class="language-javascript">import { getApiUrl， doExtrasFetch } from &quot;../../extensions.js&quot;;

const url = new URL(getApiUrl());
url.pathname = '/api/summarize';

const apiResult = await doExtrasFetch(url， {
    method: 'POST'，
    headers: {
        'Content-Type': 'application/json'，
        'Bypass-Tunnel-Reminder': 'bypass'，
    }，
    body: JSON.stringify({
        // Request body
    })
});</code></pre>
</doc-codeblock></div>
<p><code v-pre>getApiUrl()</code> 返回 Extras 服务器的基本 URL。</p>
<p><code v-pre>doExtrasFetch()</code> 函数:</p>
<ul>
<li>添加 <code v-pre>Authorization</code> 和 <code v-pre>Bypass-Tunnel-Reminder</code> headers</li>
<li>处理获取结果</li>
<li>返回结果(响应对象)</li>
</ul>
<p>这使得从扩展调用 Extras API 变得容易。</p>
<p>您可以指定:</p>
<ul>
<li>请求方法: GET、POST 等。</li>
<li>附加 headers</li>
<li>POST 请求的 body</li>
<li>任何其他 fetch 选项</li>
</ul>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                                <div class="flex flex-wrap items-center justify-between mt-14">
                                    <a id="retype-edit-this-page" class="my-2.5 inline-flex items-center text-sm whitespace-nowrap text-body-link font-body-link-weight hover:text-body-link-hover hover:underline" href="https://github.com/intellecat/SillyTavern-Docs-ZH/edit/main/For_Contributors/Writing-Extensions.md" target="_blank" rel="noopener">
                                        <svg class="mr-1.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M20 12c-.55 0-1 .45-1 1v7c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h7c.55 0 1-.45 1-1s-.45-1-1-1H4C2.35 3 1 4.35 1 6v14c0 1.65 1.35 3 3 3h14c1.65 0 3-1.35 3-3v-7c0-.55-.45-1-1-1z" /><path d="M22.21 1.79c-1.18-1.18-3.24-1.18-4.41 0l-9.5 9.5c-.13.13-.22.29-.26.46l-1 4c-.08.34.01.7.26.95.18.2.44.3.7.3.08 0 .16-.01.24-.03l4-1c.18-.04.34-.13.46-.26l9.5-9.5c1.22-1.22 1.22-3.2.01-4.42zm-1.42 3l-9.3 9.3-2.11.53.53-2.11 9.3-9.3c.42-.42 1.16-.42 1.59 0 .43.43.43 1.15-.01 1.58z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        <span>Edit this page</span>
                                    </a>
                                </div>
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../for-contributors/function-calling/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">函数调用</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../for-contributors/server-plugins/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">服务器插件</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© Copyright 2025. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "UI 扩展", level: 2, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
